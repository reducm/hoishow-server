<%# encoding: utf-8 %>

<div class="nav">
  <h2>编辑演出</h2>
  <h4>演出名称: <%= @show.name %></h4>
  <%= hidden_field_tag "show_id", @show.id %>
  <%= simple_form_for [:operation, @show], html: {class: 'show-form'} do |f| %>
    <div class='form-group'>
      <%= f.check_box :is_display %>
      <%= f.label :is_display, '是否显示' %>
      <%= f.radio_button :ticket_type, @show.ticket_type %>
      <%= f.label :ticket_type, @show.ticket_type_cn %>
    </div>
    <%= f.input :name, label: "演出名称" %>
    <%= f.input :show_time, label: "演出日期", as: :datetimepicker, input_html:{ value: get_datetime(@show.show_time) } %>
    <%= f.input :status, collection:[["开放购票中", "selling"], ["购票结束", "sell_stop"], ["即将开放", "going_to_open"]], selected: @show.status, label: 'show购票状态' %>
    <div class="form-group">
      <%= f.input :poster, label: "演出海报" %>
      <%= image_tag(@show.poster_url, size: "400x300") if @show.poster_url %>
    </div>
    <div class="form-group">
      <%= label_tag("图文描述") %>
      <%= f.kindeditor :description %>
    </div>
    <%= f.association :city, label_method: :name, value_method: :id, disabled: true, label: '城市' %>
    <%= f.association :stadium, required: false, label_method: :name, value_method: :id, disabled: true, label: '场馆' %>
    <%= f.input :stadium_map, label: '场馆地图' %>
    <div class="form-group">
      <%= image_tag(@show.stadium_map, size: "400x200") if @show.stadium_map_url %>
    </div>
    <%= f.input :seat_type, collection:[["只能选区", "selected"], ["可以选座", "selectable"]], selected: @show.seat_type, label: '选座设置' %>
    <%= f.hidden_field :concert_id, value: @concert.id %>
    <%= f.button :submit, "保存", class: 'btn-primary' %>
  <% end %>

  <div id='show_areas'>
    <h3>区域管理</h3>
    <%= link_to "新增区域", "javascript:void(0);", class: 'btn btn-default btn-xs add_area' %>
    <table class="table table-hover areas">
      <thead>
        <tr>
          <th>区域名</th>
          <% if @show.selected? %>
            <th>票价</th>
          <% end %>
          <th>座位数(座位数不能少于已售出数量)</th>
          <th>当前区域售出票数</th>
          <th>操作</th>
        </tr>
        <tbody>
          <%= render partial: "area_table", locals: {show: @show} %>
        </tbody>
      </thead>
    </table>
  </div>
</div>


<script type="text/javascript">
  (function($){
    $('.add_area').on("click", function(){
      name = prompt("请输入区域名称")
      $.post("/operation/shows/<%= @show.id %>/new_area", {area_name: name}, function(data){
        $(".areas tbody").html(data)
      })
    })

    $('.areas').on("click", ".del_area", function(){
      if(confirm("确定要删除该区域吗?")){
        area_id = $(this).parent().data('id')
        if(area_id){
          $.post("/operation/shows/<%= @show.id %>/del_area", {area_id: area_id, _method: 'delete'}, function(data){
            $(".areas tbody").html(data)
          })
        }
        else{
          $(this).parents('tr').remove()
        }
      }
    })
  })(jQuery);
</script>
